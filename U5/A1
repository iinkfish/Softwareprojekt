/*
  Blank Simple Project.c
  http://learn.parallax.com/propeller-c-tutorials 
*/
#include "simpletools.h"  
#include "ping.h"
#include "abdrive360.h"
#include "servo.h"
                                // Include simple tools
#define TR 200

//variablen fÃ¼r threads
volatile set_dist = 20;
volatile mean_dist = 20;
volatile sum_dist = 0;
volatile errorVal = 0;
volatile distance = 0;  
volatile distance2 = 0;
volatile speed = 26;                              
volatile x = 0;
volatile distance_front = 0;

                                
//thread for PI 
void thread1(){

  int errorIntegrator = 0; 
  float kp = 0.01;
  float ki = 0.01; 

  while(1){
    distance = ping_cm(17);

    errorVal = set_dist - distance;
    errorIntegrator += errorVal; 

    speed = kp * errorVal + ki*errorIntegrator; 

    if(speed > 15) speed = 15;
    if(speed < -15) speed = -15;
  }
}
  

//thread for driving
void thread2(){
  unsigned int speed2 = speed;
  // if(speed2 > 26) speed2 = 26;

  //3,25 mm pro tick -> 26 tick/s *3,25 mm/tick = 84,5 mm/s
  while(1){
    if(errorVal > 0) {
      drive_speed(26,26 + speed2);
      pause(TR);
      drive_speed(26,26);  
    }                
    
    if(errorVal < 0) {
      drive_speed(26 + speed2,26);
      pause(TR);
      drive_speed(26,26);   
    }                    

    if(errorVal == 0)                   drive_speed(26,26);  
  }
 }

 void thread3(){

 }
 
 int main(){
   servo_angle(16, 0);
   pause(2000);
   drive_speed(26,26);
    int *t1 = cog_run(&thread1, 100);
    int *t2 = cog_run(&thread2, 100);
    
      while(1){
      printf("speed: %d\n\n", speed);

      pause(100);
    }     
   //cog_end(t2);
   return 0;
 }       
